<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>مُتتبع العادات</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1067/1067357.png">
    
    <link rel="manifest" href="data:application/manifest+json,{'name':'تطبيق العادات','short_name':'عاداتي','start_url':'index.html','display':'standalone','background_color':'#ffffff','theme_color':'#2196F3','icons':[{'src':'https://cdn-icons-png.flaticon.com/512/1067/1067357.png','sizes':'512x512','type':'image/png'}]}">

    <style>
        :root { --bg: #f8f9fa; --card: #ffffff; --primary: #4caf50; --secondary: #f44336; --accent: #2196F3; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; width: 100%; max-width: 380px; background: var(--card); padding: 15px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .day { aspect-ratio: 1; background: #f0f0f0; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 15px; cursor: pointer; transition: 0.2s; font-weight: bold; color: #555; position: relative; }
        .day.checked { background: var(--primary); color: white; }
        .day.crossed { background: var(--secondary); color: white; }
        .controls { margin-top: 15px; width: 100%; max-width: 380px; background: var(--card); padding: 20px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); box-sizing: border-box; }
        label { display: block; margin: 10px 0 5px; font-size: 13px; color: #888; }
        input, textarea, button { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 12px; border: 1px solid #eee; box-sizing: border-box; font-size: 15px; }
        button { background: var(--accent); color: white; border: none; font-weight: bold; margin-top: 10px; }
        .history-list { margin-top: 15px; width: 100%; max-width: 380px; background: var(--card); border-radius: 20px; padding: 20px; box-sizing: border-box; margin-bottom: 40px; }
        .history-item { border-bottom: 1px solid #f9f9f9; padding: 12px 0; display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>

    <h2 style="margin: 10px 0 20px;">عاداتي اليومية</h2>
    
    <div class="grid" id="habitGrid"></div>

    <div class="controls">
        <label>عدد الأيام المتاحة:</label>
        <input type="number" id="daysCount" value="30">
        <label>نص التذكير:</label>
        <textarea id="notifText" rows="2"></textarea>
        <label>وقت التنبيه:</label>
        <input type="time" id="notifTime">
        <button onclick="saveSettings()">حفظ الإعدادات</button>
    </div>

    <div class="history-list">
        <h3 style="text-align:center; font-size: 16px;">سجل التواريخ</h3>
        <div id="listContainer"></div>
    </div>

    <script>
        // تسجيل الـ Service Worker لجعل المتصفح يراه كتطبيق
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }

        const grid = document.getElementById('habitGrid');
        const listContainer = document.getElementById('listContainer');
        const daysInput = document.getElementById('daysCount');
        const timeInput = document.getElementById('notifTime');
        const textInput = document.getElementById('notifText');

        let habitRecord = JSON.parse(localStorage.getItem('habit_final_store')) || {};
        daysInput.value = localStorage.getItem('c_days') || 30;
        timeInput.value = localStorage.getItem('c_time') || "21:00";
        textInput.value = localStorage.getItem('c_text') || "سجل إنجازك الآن!";

        function render() {
            grid.innerHTML = '';
            listContainer.innerHTML = '';
            const total = parseInt(daysInput.value);
            for (let i = 1; i <= total; i++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'day';
                dayEl.innerText = i;
                if (habitRecord[i]) {
                    dayEl.classList.add(habitRecord[i].status === 'check' ? 'checked' : 'crossed');
                    const item = document.createElement('div');
                    item.className = 'history-item';
                    const icon = habitRecord[i].status === 'check' ? '✅' : '❌';
                    item.innerHTML = `<span>مربع ${i} - ${habitRecord[i].date}</span> <span>${icon}</span>`;
                    listContainer.prepend(item);
                }
                let timer;
                dayEl.onclick = () => { if (timer) clearTimeout(timer); timer = setTimeout(() => updateStatus(i, 'check'), 250); };
                dayEl.ondblclick = (e) => { e.preventDefault(); clearTimeout(timer); updateStatus(i, 'cross'); };
                grid.appendChild(dayEl);
            }
        }

        function updateStatus(id, status) {
            const today = new Date().toLocaleDateString('en-GB');
            if (habitRecord[id] && habitRecord[id].status === status) delete habitRecord[id];
            else habitRecord[id] = { status: status, date: today };
            localStorage.setItem('habit_final_store', JSON.stringify(habitRecord));
            render();
        }

        function saveSettings() {
            localStorage.setItem('c_days', daysInput.value);
            localStorage.setItem('c_time', timeInput.value);
            localStorage.setItem('c_text', textInput.value);
            alert("تم الحفظ!");
            render();
            if ("Notification" in window) Notification.requestPermission();
        }

        setInterval(() => {
            const now = new Date();
            const cur = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            if (cur === localStorage.getItem('c_time') && now.getSeconds() === 0) {
                new Notification(now.toLocaleDateString('en-GB'), { body: localStorage.getItem('c_text') });
            }
        }, 1000);
        render();
    </script>
</body>
</html>
